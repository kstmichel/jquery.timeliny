(function($,window,document,undefined){"use strict";function Plugin(element,options){var el=element;var $el=$(element);var children=$el.children();options=$.extend({},$.fn["timeliny"].defaults,options);function _init(){hook("onInit");if(options.hideBlankYears===false){_addGhostElems()}_granularity();_createWrapper();_createDots();_fixBlockSizes();_clickBehavior();_createVerticalLine();_updateTimelinePos();_resizeBehavior();_dragableTimeline();_loaded()}function _reorderElems(){children.detach().sort(function(a,b){return options.order==="asc"?$(a).data("year")-$(b).data("year"):$(b).data("year")-$(a).data("year")});$el.append(children)}function _loaded(){$el.addClass("loaded");var timeline=$(".timeliny-timeline");$(timeline).addClass("year-view");$(".originalFrame").removeClass("originalFrame").addClass("visibleEvent");var currYear=$el.find("."+options.className+"-timeblock.active").first().attr("data-year");var currMonth=$el.find("."+options.className+"-timeblock.active").first().attr("data-month");var currWeek=$el.find("."+options.className+"-timeblock.active").first().attr("data-week");console.log("curr mark",currYear,currMonth,currWeek);hook("afterLoad",[currYear,currMonth,currWeek]);_updateTimelinePos()}var yearsView=true;var monthsView=false;var weeksView=false;var daysView=false;function _granularity(){console.debug("_granularity ENTER");var yearsBtn=$(".granularity-years");var monthsBtn=$(".granularity-months");var weeksBtn=$(".granularity-weeks");var daysBtn=$(".granularity-days");$(yearsBtn).click(function(){var timeline=$(".timeliny-timeline");var timeblock=$(".timeliny-timeblock");var dot=$(".timeliny-dot");var month=$(".inactive-month");var week=$(".inactive-week");var year=$(".timeliny-timeblock:not(.active)");var visibleYears=$(".timeliny-timeblock:not(.inactive-year)");console.debug("years button clicked ~!~!~!~!~!~!~!~!~!~!~!~");monthsView=false;weeksView=false;yearsView=true;$(timeline).addClass("year-view");$(timeline).removeClass("month-view weeks-view days-view");$(timeblock).removeClass(" only_event initial_events extra_events");$(dot).removeClass("clicked");$(monthsBtn).attr("disabled",false);$(weeksBtn).attr("disabled",false);$(month).remove();$(week).remove();$(year).show();$(visibleYears).addClass("visibleEvent");_addGhostElems();_updateTimelinePos();_clickBehavior()});$(monthsBtn).click(function(){var timeline=$(".timeliny-timeline");var timeblock=$(".timeliny-timeblock");var dataYear=$(".timeliny-timeblock.active").attr("data-year");var extraEvents=$(".extra_events");var dot=$(".timeliny-dot");var week=$(".inactive-week");var year=$(".timeliny-timeblock:not(.active)");yearsView=false;weeksView=false;monthsView=true;console.debug("months button clicked ~!~!~!~!~!~!~!~!~!~!~!~");$(yearsBtn).attr("disabled",false);$(weeksBtn).attr("disabled",false);$(timeline).removeClass("year-view weeks-view days-view");$(timeline).addClass("month-view");$(extraEvents).removeClass("active");$(timeblock).removeClass(" only_event initial_events extra_events");$(dot).remove();$(year).hide();$(week).remove();$(timeblock).each(function(){if($(this).attr("data-year")!==dataYear){$(this).removeClass("visibleEvent");$(this).hide();console.log("remove visible from hidden years",dataYear)}else{if($(this).attr("data-month")==$(".visibleEvent").attr("data-month")){console.log("remove extra months");$(this).last().hide()}else{$(this).addClass("visibleEvent")}}});_addGhostElems();_updateTimelinePos();_clickBehavior()});$(weeksBtn).click(function(){var timeline=$(".timeliny-timeline");var timeblock=$(".timeliny-timeblock");var active=$(".timeliny-timeblock.active");var activeYear=$(active).attr("data-year");var activeMonth=$(active).attr("data-month");var month=$(".inactive-month");console.log("weeks btn clicked ~!~!~!~!~!~!~!~!~!~!~!~");yearsView=false;monthsView=false;weeksView=true;$(yearsBtn).attr("disabled",false);$(monthsBtn).attr("disabled",false);$(weeksBtn).attr("disabled",true);$(timeline).removeClass("year-view month-view days-view");$(timeline).addClass("weeks-view");$(timeblock).removeClass(" only_event initial_events extra_events");$(month).remove();$(timeblock).each(function(){var thisYear=$(this).attr("data-year");var thisMonth=$(this).attr("data-month");if($(thisMonth)==activeMonth){$(this).removeClass("visibleEvent")}if($(thisMonth)!==activeMonth){$(this).hide()}if($(thisYear)==activeYear&&$(thisMonth)==activeMonth){$(this).addClass("visibleEvent")}});_addGhostElems();_updateTimelinePos();_clickBehavior()});$(daysBtn).click(function(){var timeline=$(".timeliny-timeline");var timeblock=$(".timeliny-timeblock");var active=$(".timeliny-timeblock.active");var activeYear=$(active).attr("data-year");var activeMonth=$(active).attr("data-month");var activeWeek=$(active).attr("data-week");var week=$(".inactive-week");var visibleDays=$(".timeliny-timeblock[data-year="+activeYear+"][data-month="+activeMonth+"][data-week="+activeWeek+"]");console.log("days btn clicked ~!~!~!~!~!~!~!~!~!~!~!~");yearsView=false;monthsView=false;weeksView=false;daysView=true;$(yearsBtn).attr("disabled",false);$(monthsBtn).attr("disabled",false);$(weeksBtn).attr("disabled",false);$(daysBtn).attr("disabled",true);$(timeline).removeClass("year-view month-view weeks-view");$(timeline).addClass("days-view");$(timeblock).removeClass(" only_event initial_events extra_events");$(week).remove();$(visibleDays).addClass("visibleEvent");console.log("actives",activeYear,activeMonth,activeWeek);_addGhostElems();_updateTimelinePos();_clickBehavior()})}function _addGhostElems(){var yearsBtn=$(".granularity-years");var monthsBtn=$(".granularity-months");var weeksBtn=$(".granularity-weeks");var daysBtn=$(".granularity-days");var timeline=$(".timeliny-timeline");var timeblock=$(".timeliny-timeblock");var dot=$(".timeliny-dot");active=$(".active");dataYear=$(active).attr("data-year");dataMonth=$(active).attr("data-month");dataDay=$(active).attr("data-day");console.debug("time variables",dataMonth,dataDay,dataYear,"active",active);var index;var frameType;var firstFrame;var lastFrame;var thisFrame;var eventsLog;var prevFrame;var nextFrame;var ghostFrame;var toggleVisible;var visibleEvents;var hiddenEvents;var search;var newY;var newYprev;if(yearsView===true){var firstYear=2008;var lastYear=2020;firstFrame=firstYear;lastFrame=lastYear;index=0;eventsLog=[];visibleEvents=$(".visibleEvent");index=0;$(yearsBtn).attr("disabled",true);console.debug("Setting up years datalog");$(visibleEvents).each(function(){if(index===0){eventsLog.push($(this).attr("data-year"));index++}if($(this).attr("data-year")!==eventsLog[index-1]){eventsLog.push($(this).attr("data-year"));index++}});index=0;console.debug("eventsLog for Years",eventsLog,firstFrame,lastFrame)}if(monthsView===true){var firstMonth=1;var lastMonth=13;firstFrame=firstMonth;lastFrame=lastMonth;visibleEvents=$(".timeliny-timeblock[data-year="+dataYear+"]");index=0;dataYear=$(active).attr("data-year");eventsLog=[];eventsLog.length=0;$(monthsBtn).attr("disabled",true);console.debug("Setting up months datalog");console.log("clear log",eventsLog);var month=$(active).attr("data-month");$(visibleEvents).each(function(){var month=$(this).attr("data-month");if($.inArray(month,eventsLog)==-1){eventsLog.push(month);index++}});index=0;console.debug("eventsLog for Months",eventsLog)}if(weeksView===true){var active=$(".active");var dataYear=$(active).attr("data-year");var dataMonth=$(active).attr("data-month");var dataDay=$(active).attr("data-day");index=0;visibleEvents=$(".timeliny-timeblock[data-year="+dataYear+"][data-month="+dataMonth+"]");console.debug("Setting up weeks datalog",dataYear,dataMonth);$(weeksBtn).attr("disabled",true);eventsLog=[];eventsLog.length=0;console.log("clear log",eventsLog,dataYear,dataMonth);var getDaysInMonth=function(month,year){return new Date(year,month,0).getDate()};thisYear=dataYear;thisMonth=Number(dataMonth).toString();var weeks=[];firstDay=1;lastDay=getDaysInMonth(dataMonth,dataYear);for(var w=firstDay;w<lastDay;w+=7){weeks.push(("0"+w).slice(-2))}console.debug("WEEKS",weeks);for(i=0;i<weeks.length;++i){if(dataDay>weeks[i]&&dataDay<weeks[i+1]){$(active).attr("data-week",weeks[i]);console.log("CREATE ACTIVE DATA-WEEK",$(active))}}var firstWeek=weeks[0];var lastWeek=weeks[weeks.length-1];firstFrame=firstWeek;lastFrame=lastWeek;console.debug("frames","thisMonth",thisMonth,"thisYear",thisYear,"firstFrame",firstFrame,"lastFrame",lastFrame);$(visibleEvents).each(function(){var week=$(this).attr("data-week");console.log("weeks log",week);if($.inArray(week,eventsLog)==-1){console.log("push weeks to log");eventsLog.push(week);index++}});index=0;console.debug("eventsLog for Weeks",eventsLog)}if(daysView===true){var firstDay;var lastDay;index=0;dataYear=$(active).attr("data-year");dataMonth=$(active).attr("data-month");dataDay=$(active).attr("data-day");toggleVisible=$(".visibleEvent");visibleEvents=$(".timeliny-timeblock[data-year="+dataYear+"][data-month="+dataMonth+"][data-week="+dataWeek+"]");hiddenEvents=$(".timeliny-timeblock:not([data-year="+dataYear+"][data-month="+dataMonth+"][data-week="+dataWeek+"])");console.debug("Setting up days datalog");var curr=new Date(dataDay+"-"+dataMonth+"-"+dataYear);var thisYear=dataYear;var thisMonth=dataMonth;var saturdays=[];var sundays=[];for(var i=0;i<=new Date(thisYear,thisMonth,0).getDate();i++){var date=new Date(thisYear,thisMonth,i);if(date.getDay()==6){saturdays.push(date)}else if(date.getDay()==0){sundays.push(date)}}console.log("DAYS SUNDAYS + SAT",sundays,saturdays);console.debug("Sunday","Current Day",sundayZeroIndex,"Saturday");firstFrame=firstDay;lastFrame=lastDay;$(daysBtn).attr("disabled",true);eventsLog=[];eventsLog.length=0;console.log("clear log",eventsLog,active,dataYear,dataMonth,dataDay);$(toggleVisible).removeClass("visibleEvent");$(hiddenEvents).hide();$(visibleEvents).each(function(){$(this).addClass("visibleEvent");var day=$(this).attr("data-day");console.log("days log");if($.inArray(day,eventsLog)==-1){console.log("push day to log");eventsLog.push(day);index++}});index=0;console.debug("eventsLog for Days",eventsLog)}if(options.order==="asc"){console.debug("ascending list---STATS",firstFrame,lastFrame,"dataMonth",dataMonth);for(var y=firstFrame;y<lastFrame;y++){dataYear=$(active).attr("data-year");dataMonth=$(active).attr("data-month");if(yearsView===true){console.log("Adding yearsView ghost frames");newY=y;frameType="timeliny-year";prevFrame=children.parent().parent().find("[data-year="+(y-1)+"]").not(dot);nextFrame=children.parent().parent().find("[data-year="+(y+1)+"]").not(dot);thisFrame=children.parent().parent().find("[data-year="+y+"]").not(dot);ghostFrame='<div data-year="'+newY+'" data-month="01" class="inactive inactive-year">'+newY+" ghost frame</div>";var today=new Date;var todayYear=today.getFullYear();thisYear=$(thisFrame).attr("data-year");console.debug("TODAY",today,"TODAY YEAR",thisYear,todayYear);if(thisYear==todayYear&&!$(".active").length){$(thisFrame).addClass("active today")}children=$el.children()}if(monthsView===true){console.log("Adding monthsView ghost frames");frameType="timeliny-month";newY=("0"+y).slice(-2);newYprev=("0"+(y-1)).slice(-2);console.log("newY",newY,"Y",y);search='[data-year="'+dataYear+'"]';prevFrame=children.parent().parent().find("[data-year="+dataYear+"][data-month="+newYprev+"]").not(dot);thisFrame=children.parent().parent().find("[data-year="+dataYear+"][data-month="+newY+"]").not(dot);ghostFrame='<div data-year="'+dataYear+'" data-month="'+newY+'" class="inactive inactive-month">'+newY+" ghost frame</div>";today=new Date;var todayMonth=today.getMonth();thisMonth=$(thisFrame).attr("data-month");console.debug("TODAY",today,"TODAY MONTH",thisMonth,todayMonth);if(thisMonth==todayMonth){$(thisFrame).addClass("active today")}children=$el.children()}if(weeksView===true){console.debug("Adding weeksView ghost frames");frameType="timeliny-week";var weeksY=weeks[y-1];newY=("0"+weeksY).slice(-2);newYprev=("0"+weeks[y-2]).slice(-2);console.log("EACH FRAME LOOP: y",y,"weeksY",weeksY,"newY",newY,"newYprev",newYprev);if(typeof weeksY==="undefined"){console.debug("WARNING....UNDEFINED");break}console.log("EACH FRAME LOOP: days in this month",getDaysInMonth(dataMonth,dataYear));search='[data-year="'+dataYear+'"][data-month="'+dataMonth+'"]';prevFrame=children.parent().parent().find("[data-year="+dataYear+"][data-month="+dataMonth+"][data-week="+newYprev+"]").not(dot);thisFrame=children.parent().parent().find("[data-year="+dataYear+"][data-month="+dataMonth+"][data-week="+newY+"]").not(dot);ghostFrame='<div data-year="'+dataYear+'" data-month="'+dataMonth+'" data-week="'+newY+'" class="inactive inactive-week">'+newY+" ghost frame</div>"}if(daysView===true){console.debug("Adding daysView ghost frames");frameType="timeliny-day";newY=("0"+y).slice(-2);newYprev=("0"+(y-1)).slice(-2);console.log("newY",newY,"Y",y);search='[data-year="'+dataYear+'"][data-month="'+dataMonth+'"][data-week="'+dataWeek+'"]';prevFrame=children.parent().parent().find("[data-year="+dataYear+"][data-month="+dataMonth+"][data-week="+dataWeek+"][data-day="+newYprev+"]").not(dot);thisFrame=children.parent().parent().find("[data-year="+dataYear+"][data-month="+dataMonth+"][data-week="+dataWeek+"][data-day="+newY+"]").not(dot);ghostFrame='<div data-year="'+dataYear+'" data-month="'+dataMonth+'" data-week="'+dataWeek+'" data-day="'+newY+'" class="inactive inactive-day">'+newY+" ghost frame</div>"}if($(thisFrame).length<=0){console.log("not detecting event...");if(newY>firstFrame){console.debug("newY is > than firstFrame",newY,firstFrame);$(prevFrame).last().after(ghostFrame);console.debug("place ghost after prevFrame",$(prevFrame),ghostFrame)}else{console.debug("newY is firstFrame",newY,firstFrame);console.debug("PLACEMENT...");if(yearsView==true){console.debug("Years configuration");children.first().before(ghostFrame)}else{console.debug("not years configuration");$(timeline).find(search).first().not(dot).before(ghostFrame)}}}else{console.debug("event exists...",newY);$(thisFrame).show();if(newY==eventsLog[index]){$(thisFrame).addClass("visibleEvent");console.debug("y Equal to EventLog, print no frame",newY,"===",eventsLog[index],index);console.debug("Mark extra events");if($(thisFrame).length>=2){$(thisFrame).first().addClass("initial_events");$(thisFrame).not(":first").addClass("extra_events")}if($(thisFrame).length===1){$(thisFrame).first().addClass("only_event").removeClass("initial_events")}if($(thisFrame).hasClass("only_event")||$(thisFrame).hasClass("initial_events")){index++;console.debug("not Only Event: add to index:",index,eventsLog[index])}else{console.debug("has only_event")}if(weeksView==true){if(newY>=29){break}$(thisFrame).attr("data-week",newY)}}}}}else{for(var x=firstFrame;x>=lastFrame;x--){if($(thisFrame).length<=0){if(newY<firstYear){$(nextFrame).after(ghostFrame)}else{children.first().before(ghostFrame)}}}}var activeExtra=$(".timeliny-timeblock.extra_events.active");var activeYear=$(activeExtra).attr("data-year");console.debug("timeline cleanup");$(".initial_events[data-year="+activeYear+"]").addClass("active");$(activeExtra).removeClass("active");_createDots()}function _createWrapper(){return $el.addClass(options.className).children().wrapAll(options.wrapper).wrapAll('<div class="'+options.className+'-timeline"></div>')}function _fixBlockSizes(){var timeBlockSize=$el.css("padding-top").replace("px","")*.8;$el.find("."+options.className+"-timeline").css("width",""+children.length*timeBlockSize+"px");$el.find("."+options.className+"-timeliny-timeblock").css("width",""+timeBlockSize+"px")}function _createDots(){console.debug("initialize dots...");children=$(".timeliny-timeline").children();children.each(function(){var text=$(this).html();var year=$(this).attr("data-year");var month=$(this).attr("data-month");var week=$(this).attr("data-week");var day=$(this).attr("data-day");var dot=$(this).find(".timeliny-dot");var dotHtml;var current=year+month+week+day;if($(text).length){console.debug("text has length");dotHtml='<a href="#'+current+'" class="'+options.className+'-dot" data-year="'+year+'" data-month="'+month+'" data-week="'+week+'" data-day="'+day+'" data-text="  "></a>'}else{console.debug("text has NO length");dotHtml='<a href="#'+current+'" class="'+options.className+'-dot" data-year="'+year+'" data-month="'+month+'" data-week="'+week+'" data-day="'+day+'" data-text="'+text+'"></a>'}$(this).addClass(""+options.className+"-timeblock").html(dotHtml)})}function _createVerticalLine(){$el.append('<div class="'+options.className+'-vertical-line"></div>')}function _updateTimelinePos(callEvent){var linePos=$el.find("."+options.className+"-vertical-line").position().left;var activeDotPos=$el.find("."+options.className+"-timeblock.active").position().left;var dotRadius=$el.find("."+options.className+"-timeblock.active ."+options.className+"-dot").width()/2;var diff=activeDotPos-linePos;var left;if(diff>0){left="-"+(Math.abs(diff)+dotRadius+1)+""}else{left="+"+(Math.abs(diff)-dotRadius-1)+""}$el.find("."+options.className+"-timeline").animate({left:left},options.animationSpeed,function(){if(typeof callEvent!="undefined"){if(callEvent==="click"){var currYear=$el.find("."+options.className+"-timeblock.active").first().attr("data-year");var currMonth=$el.find("."+options.className+"-timeblock.active").first().attr("data-month");var currWeek=$el.find("."+options.className+"-timeblock.active").first().attr("data-week");var currDay=$el.find("."+options.className+"-timeblock.active").first().attr("data-day");var current=currYear+currMonth+currWeek+currDay;console.debug("CLICKEDDDDDDDDD","years",yearsView,"months",monthsView,"weeks",weeksView,"current",current);hook("afterChange",[current]);console.log(hook,[current])}else if(callEvent==="resize")hook("afterResize")}})}function _clickBehavior(){children.parent().find("."+options.className+"-timeblock:not(.inactive) ."+options.className+"-dot").on("click",function(e){e.preventDefault();var active=$(this).parent().parent().find("."+options.className+"-timeblock.active");var currYear=$(this).parent().parent().find("."+options.className+"-timeblock.active").attr("data-year");var currMonth=$(this).parent().parent().find("."+options.className+"-timeblock.active").attr("data-month");var currWeek=$(this).parent().parent().find("."+options.className+"-timeblock.active").attr("data-week");var currDay=$(this).parent().parent().find("."+options.className+"-timeblock.active").attr("data-day");var nextYear=$(this).attr("data-year");var nextMonth=$(this).attr("data-month");var nextWeek=$(this).attr("data-week");var nextDay=$(this).attr("data-day");$(this).toggleClass("clicked");var currTarget=currYear+currMonth+currWeek+currDay;var nextTarget=nextYear+nextMonth+nextWeek+nextDay;if(currTarget!=nextTarget){hook("onLeave",[currTarget,nextTarget]);$(active).removeClass("active");$(this).closest("."+options.className+"-timeblock").addClass("active")}_updateTimelinePos("click");return false})}function _resizeBehavior(){function debounce(callback,delay){var timer;return function(){var args=arguments;var context=this;clearTimeout(timer);timer=setTimeout(function(){callback.apply(context,args)},delay)}}$(window).on("resize.timeliny",debounce(function(){_updateTimelinePos("resize")},350))}function _dragableTimeline(){var selected=null,x_pos=0,x_elem=0;function _drag_init(elem){selected=elem;x_elem=x_pos-selected.offsetLeft}function _move_elem(e){x_pos=document.all?window.event.clientX:e.pageX;if(selected!==null){selected.style.left=x_pos-x_elem+"px"}}function _stop_move(){if(selected){var linePos=$el.find("."+options.className+"-vertical-line").offset().left;var closestDotYear=null;var diff=1e23;$el.find("."+options.className+"-dot[data-year="+closestDotYear+"]").trigger("click");selected=null}}$el.first().on("mousedown",function(){_drag_init($el.find("."+options.className+"-timeline")[0]);return false});$(document).on("mousemove.timeliny",function(e){_move_elem(e)});$(document).on("mouseup.timeliny",function(){_stop_move()})}function goToYear(year){var selector=$el.find("."+options.className+"-timeblock[data-year="+year+"]:not(.inactive) ."+options.className+"-dot").first();if(selector.length>0){selector.trigger("click")}}function option(key,val){if(val){options[key]=val}else{return options[key]}}function destroy(){$el.each(function(){var el=this;var $el=$(this);$(window).off("resize.timeliny");$el.find("."+options.className+"-timeblock:not(.inactive) ."+options.className+"-dot").off("click");$(document).off("mousemove.timeliny");$(document).off("mouseup.timeliny");$el.first().off("mousedown");$el.remove();hook("onDestroy");$el.removeData("plugin_timeliny")})}function hook(hookName,args){if(options[hookName]!==undefined){options[hookName].apply(el,args)}}_init();return{option:option,destroy:destroy,goToYear:goToYear}}$.fn["timeliny"]=function(options){console.log(options);if(typeof arguments[0]==="string"){var methodName=arguments[0];var args=Array.prototype.slice.call(arguments,1);var returnVal;this.each(function(){if($.data(this,"plugin_timeliny")&&typeof $.data(this,"plugin_timeliny")[methodName]==="function"){returnVal=$.data(this,"plugin_timeliny")[methodName].apply(this,args)}else{throw new Error("Method "+methodName+" does not exist on jQuery.timeliny")}});if(returnVal!==undefined){return returnVal}else{return this}}else if(typeof options==="object"||!options){return this.each(function(){if(!$.data(this,"plugin_timeliny")){$.data(this,"plugin_timeliny",new Plugin(this,options))}})}};$.fn["timeliny"].defaults={order:"asc",className:"timeliny",wrapper:'<div class="timeliny-wrapper"></div>',boundaries:2,animationSpeed:250,hideBlankYears:false,onInit:function(){},onDestroy:function(){},afterLoad:function(currYear,currMonth,currWeek){},onLeave:function(currYear,nextYear){},afterChange:function(currYear){},afterResize:function(){}}})(jQuery,window,document);