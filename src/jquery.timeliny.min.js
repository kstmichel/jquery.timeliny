(function($,window,document,undefined){"use strict";function Plugin(element,options){var el=element;var $el=$(element);var children=$el.children();options=$.extend({},$.fn["timeliny"].defaults,options);function _init(){hook("onInit");_reorderElems();if(options.hideBlankYears===false){_addGhostElems()}_createWrapper();_createDots();_fixBlockSizes();_clickBehavior();_createVerticalLine();_updateTimelinePos();_resizeBehavior();_dragableTimeline();_loaded()}function _reorderElems(){children.detach().sort(function(a,b){return options.order==="asc"?$(a).data("year")-$(b).data("year"):$(b).data("year")-$(a).data("year")});$el.append(children)}function _loaded(){$el.addClass("loaded");var currYear=$el.find("."+options.className+"-timeblock.active").first().attr("data-year");hook("afterLoad",[currYear])}function _addGhostElems(){var firstYear=parseInt(children.first().attr("data-year"));var lastYear=parseInt(children.last().attr("data-year"));if(options.order==="asc"){for(var y=firstYear-options.boundaries;y<lastYear+options.boundaries+1;y++){if(children.parent().find("[data-year="+y+"]").length<=0){if(y>firstYear-options.boundaries){children.parent().find("[data-year="+(y-1)+"]").after('<div data-year="'+y+'" class="inactive"></div>')}else{children.first().before('<div data-year="'+y+'" class="inactive"></div>')}}}}else{for(var y=firstYear+options.boundaries;y>=lastYear-options.boundaries;y--){if(children.parent().find("[data-year="+y+"]").length<=0){if(y<firstYear+options.boundaries){children.parent().find("[data-year="+(y+1)+"]").after('<div data-year="'+y+'" class="inactive"></div>')}else{children.first().before('<div data-year="'+y+'" class="inactive"></div>')}}}}children=$el.children()}function _createWrapper(){return $el.addClass(options.className).children().wrapAll(options.wrapper).wrapAll('<div class="'+options.className+'-timeline"></div>')}function _fixBlockSizes(){var timeBlockSize=$el.css("padding-top").replace("px","")*.8;$el.find("."+options.className+"-timeline").css("width",""+children.length*timeBlockSize+"px");$el.find("."+options.className+"-timeliny-timeblock").css("width",""+timeBlockSize+"px")}function _createDots(){children.each(function(index){var text=$(this).html();var year=$(this).attr("data-year");var dotHtml='<a href="#'+year+'" class="'+options.className+'-dot" data-year="'+year+'" data-text="'+text+'"></a>';$(this).addClass(""+options.className+"-timeblock").html(dotHtml)})}function _createVerticalLine(){$el.append('<div class="'+options.className+'-vertical-line"></div>')}function _updateTimelinePos(callEvent){var linePos=$el.find("."+options.className+"-vertical-line").position().left;var activeDotPos=$el.find("."+options.className+"-timeblock.active").position().left;var dotRadius=$el.find("."+options.className+"-timeblock.active ."+options.className+"-dot").width()/2;var diff=activeDotPos-linePos;var left;if(diff>0){left="-"+(Math.abs(diff)+dotRadius+1)+""}else{left="+"+(Math.abs(diff)-dotRadius-1)+""}$el.find("."+options.className+"-timeline").animate({left:left},options.animationSpeed,function(){if(typeof callEvent!="undefined"){if(callEvent==="click"){var currYear=$el.find("."+options.className+"-timeblock.active").first().attr("data-year");hook("afterChange",[currYear])}else if(callEvent==="resize")hook("afterResize")}})}function _clickBehavior(){children.parent().find("."+options.className+"-timeblock:not(.inactive) ."+options.className+"-dot").on("click",function(e){e.preventDefault();var currYear=$(this).parent().parent().find("."+options.className+"-timeblock.active").attr("data-year");var nextYear=$(this).attr("data-year");if(currYear!=nextYear){hook("onLeave",[currYear,nextYear]);children.removeClass("active");$(this).closest("."+options.className+"-timeblock").addClass("active")}_updateTimelinePos("click");return false})}function _resizeBehavior(){function debounce(callback,delay){var timer;return function(){var args=arguments;var context=this;clearTimeout(timer);timer=setTimeout(function(){callback.apply(context,args)},delay)}}$(window).on("resize.timeliny",debounce(function(){_updateTimelinePos("resize")},350))}function _dragableTimeline(){var selected=null,x_pos=0,x_elem=0;function _drag_init(elem){selected=elem;x_elem=x_pos-selected.offsetLeft}function _move_elem(e){x_pos=document.all?window.event.clientX:e.pageX;if(selected!==null){selected.style.left=x_pos-x_elem+"px"}}function _stop_move(){if(selected){var linePos=$el.find("."+options.className+"-vertical-line").offset().left;var closestDotYear=null;var diff=1e23;children.parent().find("."+options.className+"-timeblock:not(.inactive) ."+options.className+"-dot").each(function(index){var currDotPos=$(this).offset().left;var currDiff=Math.abs(currDotPos-linePos);if(currDiff<diff){console.log($(this).attr("data-year"));closestDotYear=$(this).attr("data-year");diff=currDiff}});$el.find("."+options.className+"-dot[data-year="+closestDotYear+"]").trigger("click");selected=null}}$el.first().on("mousedown",function(){_drag_init($el.find("."+options.className+"-timeline")[0]);return false});$(document).on("mousemove.timeliny",function(e){_move_elem(e)});$(document).on("mouseup.timeliny",function(){_stop_move()})}function goToYear(year){var selector=$el.find("."+options.className+"-timeblock[data-year="+year+"]:not(.inactive) ."+options.className+"-dot").first();if(selector.length>0){selector.trigger("click")}}function option(key,val){if(val){options[key]=val}else{return options[key]}}function destroy(){$el.each(function(){var el=this;var $el=$(this);$(window).off("resize.timeliny");$el.find("."+options.className+"-timeblock:not(.inactive) ."+options.className+"-dot").off("click");$(document).off("mousemove.timeliny");$(document).off("mouseup.timeliny");$el.first().off("mousedown");$el.remove();hook("onDestroy");$el.removeData("plugin_timeliny")})}function hook(hookName,args){if(options[hookName]!==undefined){options[hookName].apply(el,args)}}_init();return{option:option,destroy:destroy,goToYear:goToYear}}$.fn["timeliny"]=function(options){console.log(options);if(typeof arguments[0]==="string"){var methodName=arguments[0];var args=Array.prototype.slice.call(arguments,1);var returnVal;this.each(function(){if($.data(this,"plugin_timeliny")&&typeof $.data(this,"plugin_timeliny")[methodName]==="function"){returnVal=$.data(this,"plugin_timeliny")[methodName].apply(this,args)}else{throw new Error("Method "+methodName+" does not exist on jQuery.timeliny")}});if(returnVal!==undefined){return returnVal}else{return this}}else if(typeof options==="object"||!options){return this.each(function(){if(!$.data(this,"plugin_timeliny")){$.data(this,"plugin_timeliny",new Plugin(this,options))}})}};$.fn["timeliny"].defaults={order:"asc",className:"timeliny",wrapper:'<div class="timeliny-wrapper"></div>',boundaries:2,animationSpeed:250,hideBlankYears:false,onInit:function(){},onDestroy:function(){},afterLoad:function(currYear){},onLeave:function(currYear,nextYear){},afterChange:function(currYear){},afterResize:function(){}}})(jQuery,window,document);